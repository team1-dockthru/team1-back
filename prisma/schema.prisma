generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int          @id @default(autoincrement())
  email                   String       @unique
  password                String?
  nickname                String
  profileImage            ProfileImage @default(USER)
  role                    UserRole     @default(USER)
  grade                   UserGrade    @default(NORMAL)
  challengeParticipations Int          @default(0)
  recommendedCount        Int          @default(0)
  tokenVersion            Int          @default(0)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  oauthAccounts OAuthAccount[]

  works         Work[]
  feedbacks     Feedback[]
  likes         Like[]
  notifications Notification[]

  @@map("users")
}

enum ProfileImage {
  ADMIN
  USER
}

enum UserRole {
  ADMIN
  USER
}

enum UserGrade {
  EXPERT
  NORMAL
}

model OAuthAccount {
  id         Int      @id @default(autoincrement())
  provider   String // "google"
  providerId String // Google sub
  email      String? // 구글 이메일
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}

enum WorkStatus {
  draft
  done
}

enum NotificationType {
  CHALLENGE_REQUEST_APPROVED
  CHALLENGE_REQUEST_REJECTED
  CHALLENGE_DELETED
  CHALLENGE_CLOSED

  WORK_CREATED
  WORK_UPDATED
  WORK_DELETED

  FEEDBACK_CREATED
  FEEDBACK_UPDATED
  FEEDBACK_DELETED
}

model Work {
  id          Int        @id @default(autoincrement()) @map("work_id")
  challengeId Int        @map("challenge_id")
  userId      Int        @map("user_id")
  title       String     @db.Text
  content     String     @db.Text
  originalUrl String?    @map("original_url")
  workStatus  WorkStatus @map("work_status")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  submittedAt DateTime?  @map("submitted_at")

  user          User           @relation(fields: [userId], references: [id])
  feedbacks     Feedback[]
  likes         Like[]
  notifications Notification[]

  @@index([userId])
  @@index([challengeId])
  @@map("work")
}

model Feedback {
  id        Int      @id @default(autoincrement()) @map("feedback_pk")
  userId    Int      @map("user_pk")
  workId    Int      @map("work_pk")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  work Work @relation(fields: [workId], references: [id])

  @@index([userId])
  @@index([workId])
  @@map("feedback")
}

model Like {
  userId    Int      @map("user_pk")
  workId    Int      @map("work_pk")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  work Work @relation(fields: [workId], references: [id])

  @@id([userId, workId])
  @@map("like")
}

model Notification {
  id          Int              @id @default(autoincrement()) @map("notification_pk")
  userId      Int              @map("user_pk")
  challengeId Int?             @map("challenge_pk")
  workId      Int?             @map("work_pk")
  type        NotificationType @map("type")
  message     String           @db.Text
  createdAt   DateTime         @default(now()) @map("created_at")
  readAt      DateTime?        @map("read_at")

  user User  @relation(fields: [userId], references: [id])
  work Work? @relation(fields: [workId], references: [id])

  @@index([userId])
  @@index([workId])
  @@map("notification")
}
