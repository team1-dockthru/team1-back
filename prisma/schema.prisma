generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int          @id @default(autoincrement())
  email                   String       @unique
  password                String?
  nickname                String
  profileImage            ProfileImage @default(USER)
  role                    UserRole     @default(USER)
  grade                   UserGrade    @default(NORMAL)
  challengeParticipations Int          @default(0)
  recommendedCount        Int          @default(0)
  tokenVersion            Int          @default(0)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  oauthAccounts OAuthAccount[]

  works                Work[]
  feedbacks            Feedback[]
  likes                Like[]
  notifications        Notification[]
  challengeRequests    ChallengeRequest[]
  challenges           Challenge[]
  challengeParticipants ChallengeParticipant[]

  @@map("users")
}

enum ProfileImage {
  ADMIN // 0
  USER  // 1
}

enum UserRole {
  ADMIN // 0
  USER  // 1
}

enum UserGrade {
  EXPERT // 0
  NORMAL // 1
}

model OAuthAccount {
  id           Int      @id @default(autoincrement())
  provider     String   // "google"
  providerId   String   // Google sub
  email        String?  // 구글 이메일
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}

enum WorkStatus {
  draft
  done
}

enum NotificationType {
  CHALLENGE_REQUEST_APPROVED
  CHALLENGE_REQUEST_REJECTED
  CHALLENGE_DELETED
  CHALLENGE_CLOSED

  WORK_CREATED
  WORK_UPDATED
  WORK_DELETED

  FEEDBACK_CREATED
  FEEDBACK_UPDATED
  FEEDBACK_DELETED
}

enum DocType {
  OFFICIAL_DOCUMENT // 공식문서
  BLOG              // 블로그
}

enum ChallengeStatus {
  IN_PROGRESS // 진행중
  COMPLETED   // 완료 (마감일 도래)
  CLOSED      // 마감 (관리자에 의해 강제 마감)
}

enum ParticipantStatus {
  PENDING          // 승인 대기
  REJECTED         // 신청 거절
  APPROVED         // 신청승인
  CHALLENGE_DELETED // 챌린지 삭제
}

enum RequestStatus {
  PENDING   // 신청중
  APPROVED  // 승인
  REJECTED  // 거절
  CANCELLED // 취소
}

model Work {
  id          Int        @id @default(autoincrement()) @map("work_id")
  challengeId Int        @map("challenge_id")
  userId      Int        @map("user_id")
  title       String     @db.Text
  content     String     @db.Text
  originalUrl String?    @map("original_url")
  workStatus  WorkStatus @map("work_status")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  submittedAt DateTime?  @map("submitted_at")

  user          User           @relation(fields: [userId], references: [id])
  challenge     Challenge      @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  feedbacks     Feedback[]
  likes         Like[]
  notifications Notification[]

  @@index([userId])
  @@index([challengeId])
  @@map("work")
}

model Feedback {
  id        Int      @id @default(autoincrement()) @map("feedback_pk")
  userId    Int      @map("user_pk")
  workId    Int      @map("work_pk")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([workId])
  @@map("feedback")
}

model Like {
  userId    Int      @map("user_pk")
  workId    Int      @map("work_pk")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@id([userId, workId])
  @@map("like")
}

model Notification {
  id          Int              @id @default(autoincrement()) @map("notification_pk")
  userId      Int              @map("user_pk")
  challengeId Int?             @map("challenge_pk")
  workId      Int?             @map("work_pk")
  type        NotificationType @map("type")
  message     String           @db.Text
  createdAt   DateTime         @default(now()) @map("created_at")
  readAt      DateTime?        @map("read_at")

  user      User       @relation(fields: [userId], references: [id])
  work      Work?      @relation(fields: [workId], references: [id], onDelete: Cascade)
  challenge Challenge? @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([workId])
  @@index([challengeId])
  @@map("notification")
}

model ChallengeRequest {
  id              Int           @id @default(autoincrement()) @map("challenge_request_pk")
  userId          Int           @map("user_pk")
  title           String        @db.Text
  sourceUrl       String        @map("source_url")
  field           String        @db.Text
  docType         DocType       @map("doc_type")
  deadlineAt      DateTime      @map("deadline_at")
  maxParticipants Int           @map("max_participants")
  content         String        @db.Text
  requestStatus   RequestStatus @default(PENDING) @map("request_status")
  adminReason     String?       @db.Text @map("admin_reason")
  processedAt     DateTime?     @map("processed_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id])
  challenges Challenge[]

  @@index([userId])
  @@map("challenge_request")
}

model Challenge {
  id                 Int             @id @default(autoincrement()) @map("challenge_pk")
  userId             Int             @map("user_pk")
  challengeRequestId Int?            @map("challenge_request_pk")
  title              String          @db.Text
  sourceUrl          String          @map("source_url")
  field              String          @db.Text
  docType            DocType         @map("doc_type")
  deadlineAt         DateTime        @map("deadline_at")
  maxParticipants    Int             @map("max_participants")
  content            String          @db.Text
  challengeStatus    ChallengeStatus @default(IN_PROGRESS) @map("challenge_status")
  adminReason        String?         @db.Text @map("admin_reason")
  deletedAt          DateTime?       @map("deleted_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id])
  challengeRequest ChallengeRequest? @relation(fields: [challengeRequestId], references: [id])
  works            Work[]
  participants     ChallengeParticipant[]
  notifications    Notification[]

  @@index([userId])
  @@index([challengeRequestId])
  @@map("challenge")
}

model ChallengeParticipant {
  id                Int               @id @default(autoincrement()) @map("challenge_participant_pk")
  userId            Int               @map("user_pk")
  challengeId       Int               @map("challenge_pk")
  participantStatus ParticipantStatus @default(PENDING) @map("participant_status")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id])
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
  @@map("challenge_participant")
}